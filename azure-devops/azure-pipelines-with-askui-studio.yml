# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

jobs:
  - job: RunAskUI
    continueOnError: true
    pool:
      vmImage: ubuntu-latest
    steps:
      - task: DockerInstaller@0
        inputs:
          dockerVersion: '17.09.0-ce'
      - bash: |
          cat << EOF > config.yaml
              access_token: $(ASKUI_TOKEN)
              inference_server_url: $(ASKUI_INFERENCE_SERVER_URL)
              workspace_id: $(ASKUI_WORKSPACE_ID)
              workflow_endpoint:
                  prefixes:
                      - workspaces/$(ASKUI_WORKSPACE_ID)/test-cases
                  url: $(ASKUI_WORKFLOW_ENDPOINT_URL)/workspaces/$(ASKUI_WORKSPACE_ID)/objects
          EOF
        - docker run --shm-size="2g" --rm -v ./config.yaml:/home/askui/config.yaml -v ./allure-results:/home/askui/test_project/allure-results askuigmbh/askui-runner:v0.13.1-github
        displayName: 'Run AskUI'
  - job: GenerateAllureReport
    pool:
      vmImage: ubuntu-latest
    container:
      pradapjackie/allure-reports-generation:1.0
    steps:
      - bash: |
          allure generate allure-results -o allure-report
          mv allure-report history
      # Install https://github.com/mclay/azure-pipeline-allure-report first
      - task: PublishAllureReport@1
        displayName: 'Publish Allure Report'
        inputs:
          reportDir: 'history'
